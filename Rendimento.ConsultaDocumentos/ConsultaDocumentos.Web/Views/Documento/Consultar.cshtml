@model ConsultaDocumentos.Web.Models.ConsultaDocumentoViewModel

@{
    ViewData["Title"] = "Consultar Documento";
    var resultado = ViewBag.Resultado as ConsultaDocumentos.Web.Models.ConsultaDocumentoResultViewModel;
}

<!-- Page Header -->
<div class="page-header fade-in">
    <div>
        <h1><i class="fas fa-search"></i> Consultar Documento</h1>
        <p class="page-description">Consulte CPF/CNPJ nos provedores cadastrados</p>
    </div>
</div>

<div class="row">
    <!-- Formulário de Consulta -->
    <div class="col-md-12">
        <div class="card-modern fade-in">
            <div class="card-modern-header">
                <h5><i class="fas fa-search"></i> Formulário de Consulta</h5>
            </div>
            <div class="card-modern-body">
                <form asp-action="Consultar" method="post" class="form-modern">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <div class="row">
                        <!-- Aplicação -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="AplicacaoId" class="form-label">Aplicação</label>
                                <div class="input-group-modern">
                                    <span class="input-icon">
                                        <i class="fas fa-desktop"></i>
                                    </span>
                                    <select asp-for="AplicacaoId" class="form-control" asp-items="@ViewBag.Aplicacoes">
                                        <option value="">Selecione uma aplicação</option>
                                    </select>
                                </div>
                                <span asp-validation-for="AplicacaoId" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Tipo de Consulta -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="TipoConsulta" class="form-label">Tipo de Consulta</label>
                                <div class="input-group-modern">
                                    <span class="input-icon">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <select asp-for="TipoConsulta" class="form-control">
                                        <option value="1">Consulta Completa</option>
                                        <option value="2">Consulta Simples</option>
                                        <option value="3">Consulta por Validade</option>
                                        <option value="4">Consulta Sócio</option>
                                    </select>
                                </div>
                                <span asp-validation-for="TipoConsulta" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Tipo de Documento -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="TipoDocumento" class="form-label">Tipo de Documento</label>
                                <div class="radio-group-modern">
                                    <div class="radio-item-modern">
                                        <input class="radio-input-modern" type="radio" asp-for="TipoDocumento" value="CPF" id="tipoCPF" checked />
                                        <label class="radio-label-modern" for="tipoCPF">
                                            <i class="fas fa-user"></i> CPF
                                        </label>
                                    </div>
                                    <div class="radio-item-modern">
                                        <input class="radio-input-modern" type="radio" asp-for="TipoDocumento" value="CNPJ" id="tipoCNPJ" />
                                        <label class="radio-label-modern" for="tipoCNPJ">
                                            <i class="fas fa-building"></i> CNPJ
                                        </label>
                                    </div>
                                </div>
                                <span asp-validation-for="TipoDocumento" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Número do Documento -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="NumeroDocumento" class="form-label">Número do Documento</label>
                                <div class="input-group-modern">
                                    <span class="input-icon">
                                        <i class="fas fa-id-card"></i>
                                    </span>
                                    <input asp-for="NumeroDocumento" class="form-control" placeholder="Digite o CPF ou CNPJ" />
                                </div>
                                <span asp-validation-for="NumeroDocumento" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Perfil CNPJ (condicional) -->
                        <div class="col-md-4">
                            <div class="form-group" id="divPerfilCNPJ" style="display: none;">
                                <label asp-for="PerfilCNPJ" class="form-label">Perfil CNPJ</label>
                                <div class="input-group-modern">
                                    <span class="input-icon">
                                        <i class="fas fa-list"></i>
                                    </span>
                                    <select asp-for="PerfilCNPJ" class="form-control">
                                        <option value="1">Perfil 1 - Básico</option>
                                        <option value="2">Perfil 2 - Completo</option>
                                        <option value="3" selected>Perfil 3 - Com Sócios</option>
                                    </select>
                                </div>
                                <span asp-validation-for="PerfilCNPJ" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Consultar Vencidos -->
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" asp-for="ConsultarVencidos" id="consultarVencidos" />
                                    <label class="form-check-label" for="consultarVencidos">
                                        <i class="fas fa-calendar-times"></i> Incluir documentos vencidos do cache
                                    </label>
                                </div>
                                <span asp-validation-for="ConsultarVencidos" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Origem da Consulta -->
                    <div class="form-group">
                        <label asp-for="OrigemConsulta" class="form-label">Origem da Consulta</label>
                        <div class="radio-group-modern">
                            <div class="radio-item-modern">
                                <input class="radio-input-modern" type="radio" asp-for="OrigemConsulta" value="1" id="origemRepositorioEHubs" checked />
                                <label class="radio-label-modern" for="origemRepositorioEHubs">
                                    <i class="fas fa-exchange-alt"></i> Repositório e Hubs
                                </label>
                            </div>
                            <div class="radio-item-modern">
                                <input class="radio-input-modern" type="radio" asp-for="OrigemConsulta" value="2" id="origemRepositorio" />
                                <label class="radio-label-modern" for="origemRepositorio">
                                    <i class="fas fa-database"></i> Apenas Repositório
                                </label>
                            </div>
                            <div class="radio-item-modern">
                                <input class="radio-input-modern" type="radio" asp-for="OrigemConsulta" value="3" id="origemHubs" />
                                <label class="radio-label-modern" for="origemHubs">
                                    <i class="fas fa-cloud"></i> Apenas Hubs
                                </label>
                            </div>
                        </div>
                        <span asp-validation-for="OrigemConsulta" class="text-danger"></span>
                    </div>

                    <!-- Botão de Consulta -->
                    <div class="form-group">
                        <button type="submit" class="btn-modern btn-primary-modern">
                            <i class="fas fa-search"></i> Consultar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Resultado da Consulta -->
@if (resultado != null)
{
    <div class="row mt-4">
        <div class="col-md-12">
            @if (resultado.Sucesso)
            {
                <!-- Alert de Sucesso -->
                <div class="alert-modern alert-success fade-in">
                    <div class="alert-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4 class="alert-title">@resultado.Mensagem</h4>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <p class="mb-2"><strong>Provedor:</strong></p>
                                <span class="badge-modern badge-primary">@resultado.ProvedorUtilizado</span>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-2"><strong>Origem:</strong></p>
                                <span class="badge-modern @(resultado.OrigemCache ? "badge-info" : "badge-warning")">
                                    <i class="fas @(resultado.OrigemCache ? "fa-database" : "fa-cloud")"></i>
                                    @(resultado.OrigemCache ? "Cache" : "Consulta ao Provider")
                                </span>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-2"><strong>Tempo de processamento:</strong></p>
                                <span class="badge-modern badge-secondary">
                                    <i class="fas fa-clock"></i> @resultado.TempoProcessamentoMs ms
                                </span>
                            </div>
                            @if (resultado.ProvedoresTentados?.Any() == true)
                            {
                                <div class="col-md-3">
                                    <p class="mb-2"><strong>Provedores tentados:</strong></p>
                                    <span class="badge-modern badge-secondary">@string.Join(", ", resultado.ProvedoresTentados)</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Card com Dados do Documento -->
                @if (resultado.Documento != null)
                {
                    <div class="card-modern fade-in mt-3">
                        <div class="card-modern-header">
                            <h5>
                                <i class="fas fa-file-alt"></i> Dados do Documento
                                <span class="badge-modern badge-success ms-2">
                                    @(resultado.Documento.TipoPessoa == 'F' ? "Pessoa Física" : "Pessoa Jurídica")
                                </span>
                            </h5>
                        </div>
                        <div class="card-modern-body">
                            <!-- Dados Principais -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="info-item">
                                        <label><i class="fas fa-hashtag"></i> Número</label>
                                        <p>@resultado.Documento.Numero</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="info-item">
                                        <label><i class="fas fa-user"></i> Nome</label>
                                        <p>@resultado.Documento.Nome</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="info-item">
                                        <label><i class="fas fa-id-badge"></i> Tipo Pessoa</label>
                                        <p>@(resultado.Documento.TipoPessoa == 'F' ? "Física" : "Jurídica")</p>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <label><i class="fas fa-calendar-check"></i> Data Consulta</label>
                                        <p>@resultado.Documento.DataConsulta.ToString("dd/MM/yyyy HH:mm")</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <label><i class="fas fa-calendar-times"></i> Válido até</label>
                                        <p>@resultado.Documento.DataConsultaValidade.ToString("dd/MM/yyyy HH:mm")</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Dados Pessoa Física -->
                            @if (resultado.Documento.TipoPessoa == 'F')
                            {
                                <hr class="my-4" />
                                <h6 class="mb-3"><i class="fas fa-user-circle"></i> Dados Pessoa Física</h6>
                                <div class="row">
                                    @if (resultado.Documento.DataNascimento.HasValue)
                                    {
                                        <div class="col-md-4">
                                            <div class="info-item">
                                                <label><i class="fas fa-birthday-cake"></i> Data Nascimento</label>
                                                <p>@resultado.Documento.DataNascimento.Value.ToString("dd/MM/yyyy")</p>
                                            </div>
                                        </div>
                                    }
                                    <div class="col-md-4">
                                        <div class="info-item">
                                            <label><i class="fas fa-female"></i> Nome da Mãe</label>
                                            <p>@resultado.Documento.NomeMae</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="info-item">
                                            <label><i class="fas fa-venus-mars"></i> Sexo</label>
                                            <p>@resultado.Documento.Sexo</p>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Dados Pessoa Jurídica -->
                            @if (resultado.Documento.TipoPessoa == 'J')
                            {
                                <hr class="my-4" />
                                <h6 class="mb-3"><i class="fas fa-building"></i> Dados Pessoa Jurídica</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="info-item">
                                            <label><i class="fas fa-store"></i> Nome Fantasia</label>
                                            <p>@resultado.Documento.NomeFantasia</p>
                                        </div>
                                    </div>
                                    @if (resultado.Documento.DataAbertura.HasValue)
                                    {
                                        <div class="col-md-4">
                                            <div class="info-item">
                                                <label><i class="fas fa-calendar-plus"></i> Data Abertura</label>
                                                <p>@resultado.Documento.DataAbertura.Value.ToString("dd/MM/yyyy")</p>
                                            </div>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(resultado.Documento.Inscricao))
                                    {
                                        <div class="col-md-4">
                                            <div class="info-item">
                                                <label><i class="fas fa-file-invoice"></i> Inscrição</label>
                                                <p>@resultado.Documento.Inscricao</p>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- Alert de Erro -->
                <div class="alert-modern alert-danger fade-in">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4 class="alert-title">Erro na Consulta</h4>
                        <p class="mb-2">@resultado.Mensagem</p>
                        @if (!string.IsNullOrEmpty(resultado.Erro))
                        {
                            <div class="mt-3">
                                <strong><i class="fas fa-info-circle"></i> Detalhes:</strong>
                                <p class="mb-0 mt-1">@resultado.Erro</p>
                            </div>
                        }
                        @if (resultado.ProvedoresTentados?.Any() == true)
                        {
                            <div class="mt-3">
                                <strong><i class="fas fa-server"></i> Provedores tentados:</strong>
                                <div class="mt-2">
                                    @foreach (var provedor in resultado.ProvedoresTentados)
                                    {
                                        <span class="badge-modern badge-secondary me-2">@provedor</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            // Mostrar/esconder perfil CNPJ baseado no tipo selecionado
            $('input[name="TipoDocumento"]').change(function() {
                if ($(this).val() === 'CNPJ') {
                    $('#divPerfilCNPJ').show();
                } else {
                    $('#divPerfilCNPJ').hide();
                }
            });

            // Verificar estado inicial
            if ($('input[name="TipoDocumento"]:checked').val() === 'CNPJ') {
                $('#divPerfilCNPJ').show();
            }
        });
    </script>
}
